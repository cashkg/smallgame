<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>暗黑背包：煉獄整理術</title>
    <style>
        :root {
            --bg: #050505;
            --panel: #151515;
            --gold: #d4af37;
            --border: #333;
            --grid-size: 50px;
        }

        body {
            background: var(--bg);
            color: #eee;
            font-family: 'Crimson Text', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }

        /* 頂部資訊 */
        #header {
            width: 100%;
            padding: 10px;
            background: #000;
            text-align: center;
            border-bottom: 2px solid var(--gold);
        }

        /* 主遊戲區域 */
        #game-world {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: 80vh;
        }

        /* 背包區域：網格系統 */
        #backpack-container {
            background: var(--panel);
            border: 3px solid #444;
            display: grid;
            grid-template-columns: repeat(6, var(--grid-size));
            grid-template-rows: repeat(6, var(--grid-size));
            position: relative;
            background-image: 
                linear-gradient(to right, #222 1px, transparent 1px),
                linear-gradient(to bottom, #222 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
        }

        /* 裝備樣式 */
        .item {
            position: absolute;
            background: rgba(100, 50, 50, 0.8);
            border: 2px solid #844;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
            transition: transform 0.1s;
            user-select: none;
        }
        .item:active { cursor: grabbing; z-index: 100; }
        .item.synergy { border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        /* 商店/掉落區 */
        #shop {
            width: 250px;
            background: var(--panel);
            border: 2px solid var(--border);
            padding: 10px;
        }

        .shop-item {
            background: #222;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #555;
            cursor: pointer;
        }
        .shop-item:hover { border-color: var(--gold); }

        /* 戰鬥訊息 */
        #battle-log {
            width: 300px;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
        }

        button {
            background: #600;
            color: white;
            border: 1px solid var(--gold);
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #900; }
    </style>
</head>
<body>

<div id="header">
    <h1>暗黑背包：煉獄整理術</h1>
    <div>金幣: <span id="gold-count">50</span> | 樓層: <span id="floor">1</span></div>
</div>

<div id="game-world">
    <div>
        <h3>你的背包 (拖動調整位置)</h3>
        <div id="backpack-container"></div>
        <button onclick="startBattle()">進入傳送門 (戰鬥)</button>
    </div>

    <div id="shop">
        <h3>黑市商人</h3>
        <div id="shop-list"></div>
        <p style="font-size: 12px; color: #888;">* 購買後裝備會出現在左上角，請自行排列。</p>
    </div>

    <div id="battle-log">
        <h3>戰鬥紀錄</h3>
        <div id="logs"></div>
    </div>
</div>

<script>
    let gold = 50;
    let floor = 1;
    let itemsInBag = [];
    const gridSize = 50;

    // 裝備資料庫
    const itemData = [
        { name: "生鏽短劍", w: 1, h: 2, atk: 5, cost: 10, color: "#555", effect: "weapon" },
        { name: "磨刀石", w: 1, h: 1, atk: 0, cost: 15, color: "#864", effect: "buff_atk" },
        { name: "木盾", w: 2, h: 2, def: 10, cost: 20, color: "#454", effect: "armor" },
        { name: "地獄火符", w: 1, h: 1, atk: 15, cost: 30, color: "#a40", effect: "weapon" }
    ];

    function initShop() {
        const shopList = document.getElementById('shop-list');
        shopList.innerHTML = '';
        itemData.forEach(data => {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `<b>${data.name}</b> (${data.w}x${data.h})<br>價格: ${data.cost}金幣`;
            div.onclick = () => buyItem(data);
            shopList.appendChild(div);
        });
    }

    function buyItem(data) {
        if (gold >= data.cost) {
            gold -= data.cost;
            document.getElementById('gold-count').innerText = gold;
            createBagItem(data);
        } else {
            alert("金幣不足！");
        }
    }

    function createBagItem(data) {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        itemEl.style.width = (data.w * gridSize - 4) + 'px';
        itemEl.style.height = (data.h * gridSize - 4) + 'px';
        itemEl.style.backgroundColor = data.color;
        itemEl.innerHTML = `<span>${data.name}</span>`;
        itemEl.dataset.x = 0;
        itemEl.dataset.y = 0;
        
        // 拖拽邏輯
        let isDragging = false;
        itemEl.onmousedown = (e) => {
            isDragging = true;
            let shiftX = e.clientX - itemEl.getBoundingClientRect().left;
            let shiftY = e.clientY - itemEl.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                let rect = document.getElementById('backpack-container').getBoundingClientRect();
                let x = Math.round((pageX - rect.left - shiftX) / gridSize) * gridSize;
                let y = Math.round((pageY - rect.top - shiftY) / gridSize) * gridSize;
                
                // 限制邊界
                x = Math.max(0, Math.min(x, (6 - data.w) * gridSize));
                y = Math.max(0, Math.min(y, (6 - data.h) * gridSize));

                itemEl.style.left = x + 'px';
                itemEl.style.top = y + 'px';
                itemEl.dataset.x = x / gridSize;
                itemEl.dataset.y = y / gridSize;
            }

            document.onmousemove = (e) => moveAt(e.pageX, e.pageY);
            document.onmouseup = () => {
                document.onmousemove = null;
                isDragging = false;
                checkSynergies();
            };
        };

        document.getElementById('backpack-container').appendChild(itemEl);
        itemsInBag.push({ el: itemEl, data: data });
    }

    function checkSynergies() {
        // 簡單的連鎖檢測：如果磨刀石旁邊有武器，武器加成
        itemsInBag.forEach(item => item.el.classList.remove('synergy'));
        
        itemsInBag.forEach(item => {
            if (item.data.effect === 'buff_atk') {
                itemsInBag.forEach(other => {
                    if (other.data.effect === 'weapon') {
                        // 檢測距離
                        let dist = Math.abs(item.el.dataset.x - other.el.dataset.x) + Math.abs(item.el.dataset.y - other.el.dataset.y);
                        if (dist <= 2) {
                            other.el.classList.add('synergy');
                        }
                    }
                });
            }
        });
    }

    function startBattle() {
        const logs = document.getElementById('logs');
        let totalAtk = 10;
        
        itemsInBag.forEach(item => {
            let bonus = 0;
            if (item.el.classList.contains('synergy')) bonus = 10;
            if (item.data.atk) totalAtk += item.data.atk + bonus;
        });

        let mobHp = 30 + (floor * 20);
        logs.innerHTML = `<div style="color:red">-- 進入第 ${floor} 層 --</div>` + logs.innerHTML;
        
        if (totalAtk >= mobHp) {
            let winGold = 20 + floor * 5;
            gold += winGold;
            logs.innerHTML = `<div style="color:gold">擊敗惡魔！獲得 ${winGold} 金幣</div>` + logs.innerHTML;
            floor++;
        } else {
            logs.innerHTML = `<div style="color:gray">攻擊力不足 (${totalAtk}/${mobHp})，撤退回城...</div>` + logs.innerHTML;
        }

        document.getElementById('gold-count').innerText = gold;
        document.getElementById('floor').innerText = floor;
    }

    initShop();
</script>
</body>
</html>
